{% load l10n_tags %}
{% load embed %}
  <article id="id_new_page" class="task_view">
    <br />
    <fieldset>
    <form id="id_new_page_form" action="{% locale_url page_create slug=project.slug %}" method="post">
      {% csrf_token %}
      {% if preview %}
        <div class="preview">
            <h1 class="{% if page.collaborative %}collaborative{% endif %} school_header">
              {{ _('[Preview]') }} {{ page.title }}
            </h1>
            {% if is_challenge %}<br>{{ page.sub_header|default:"" }} {% endif %}
            <hr />
            <div id="task-body-preview">
              {{ page.content|embed|safe }}
            </div>
        </div>
        <br />
      {% endif %}
      {% if form.title %}
        <div class="field{% if form.title.errors %} error{% endif %}">
          <label for="id_title">{{ _('Title') }}</label>
          <span class="hint block">{{ _('A good title is short and descriptive.') }}</span>
          {{ form.title }}
          {{ form.title.errors }}
        </div>
      {% endif %}
      {% if form.sub_header %}
        <div class="field{% if form.sub_header.errors %} error{% endif %}">
          <label for="id_sub_header">{{ _('One sentence description') }}</label>
          <span class="hint block">{{ _('This description will be used as sub header below the task title.') }}</span>
          {{ form.sub_header }}
          {{ form.sub_header.errors }}
        </div>
      {% endif %}
      <div class="field{% if form.content.errors %} error{% endif %}">
        {{ form.content }}
        {{ form.content.errors }}
      </div>
      {% if form.collaborative %}
        <div class="field{% if form.collaborative.errors %} error{% endif %}">
          {{ form.collaborative }} {{ _('Collaborative work (editable by all the participants).') }}
          {{ form.collaborative.errors }}
        </div>
      {% endif %}
      <p class="content_buttons">
        <button type="submit" id="createButton" name="create" value="{{ _('Create') }}">{{ _('Create') }}</button>
        <button type="submit" id="cancelButton" name="cancel" value="{{ _('Cancel') }}">{{ _('Cancel') }}</button>
      </p>
    </form>
    </fieldset>

    <script>
    $(document).ready( function(){
        $("#createButton").bind('click', function(e){
            e.preventDefault();
            // TODO: remove hack to fix ckeditor!
            var ckeditor_text_area_id = $("#id_new_page_form").find('textarea').attr('id');
            $("#id_new_page_form").find('textarea').val(CKEDITOR.instances[ckeditor_text_area_id].getData());
            $.post(
                $("#id_new_page_form").attr('action'),
                $("#id_new_page_form").serialize(),
                function(data){
                    $("#id_new_page").replaceWith(data);
                }
            );
        });
        $("#cancelButton").bind('click', function(e){
            e.preventDefault();
            $("#id_new_page").remove();
        });
    });
    </script>
  </article>
